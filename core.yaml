# NOTE: This file is merged with other values in ./helmfile.d/snippets/env.gotmpl
k8s:
  namespaces:
    - name: cert-manager
      disableIstioInjection: true
    - name: default
      disableIstioInjection: true
      disablePolicyChecks: true
    - name: drone-pipelines
      disableIstioInjection: true
      disablePolicyChecks: true
    - name: external-dns
      disableIstioInjection: true
    - name: harbor
    - name: gatekeeper-system
      disableIstioInjection: true
    - name: gitea
    - name: istio-system
      disableIstioInjection: true
    - name: ingress
      # disabling istio sidecar as it does not preserve client ip (yet)
      # TODO: enable once it does
      disableIstioInjection: true
    - name: jaeger
    - name: jaeger-operator
      disableIstioInjection: true
    - name: keycloak
    - name: kiali
    - name: kiali-operator
      disableIstioInjection: true
    - name: knative-serving
      disablePolicyChecks: true
      disableIstioInjection: true
    - name: kubeapps
      disableIstioInjection: true
      disablePolicyChecks: true
    - name: maintenance
      disableIstioInjection: true
    - name: monitoring
      disableIstioInjection: true
    - name: operator-lifecycle-manager
      disableIstioInjection: true
      disablePolicyChecks: true
    - name: otomi
    - name: overprovisioner
      disableIstioInjection: true
    - name: shared
    - name: team-admin
    - name: vault

adminApps:
  - name: alertmanager
    tags: [alerting, observability]
    deps: [prometheus]
    ingress:
      - svc: po-alertmanager
        namespace: monitoring
        port: 9093
        type: public
        auth: true
  - name: cert-manager
    tags: [ingress, security, tls]
  - name: drone
    tags: [cicd, deployment, pipeline]
    isShared: true
    ownHost: true
    ingress:
      - svc: drone
        namespace: team-admin
        type: public
        auth: true
        removeRequestHeaders:
          - authorization
      - svc: drone
        namespace: team-admin
        type: public
        paths: [/hook, /api/user, /api/repo]
        forwardPath: true
        removeRequestHeaders:
          - authorization
  - name: external-dns
    tags: [ingress, security, tls]
  - name: gatekeeper
    tags: [security, policies, observability]
    deps: [prometheus]
  - name: gitea
    tags: [git]
    isShared: true
    ownHost: true
    ingress:
      - namespace: gitea
        svc: gitea-http
        port: 3000
        type: public
  - name: grafana
    tags: [tracing, telemetry, observability]
    deps: [prometheus]
    ownHost: true
    ingress:
      - svc: po-grafana
        namespace: monitoring
        removeRequestHeaders:
          - authorization
        type: public
        auth: true
  - name: harbor
    tags: [security]
    deps: [istio]
    isShared: true
    ownHost: true
    ingress:
      - svc: harbor-portal
        namespace: harbor
        type: public
        auth: true
      - svc: harbor-core
        namespace: harbor
        paths: [/api/, /c/, /chartrepo/]
        forwardPath: true
        type: public
        auth: true
      - svc: harbor-core
        namespace: harbor
        paths: [/service/, /v1/, /v2/]
        forwardPath: true
        type: public
  - name: hello
    hide: true
    tags: [demo]
    deps: []
  - name: httpbin
    tags: [dev, testing, debugging]
    isShared: true
    ownHost: true
    ingress:
      - namespace: shared
        svc: httpbin
        type: public
        auth: true
  - name: ingress-nginx
    tags: [ingress, auth]
  - name: istio
    tags: [ingress, egress, routing, security, tls, observability, policies]
    deps: [grafana, prometheus]
  - name: jaeger
    tags: [ingress, telemetry, observability]
    deps: [istio]
    ingress:
      - svc: jaeger-operator-jaeger-query
        port: 16686
        forwardPath: true
        namespace: jaeger
        type: public
        auth: true
  - name: keycloak
    tags: [auth, sso]
    deps: [istio]
    ownHost: true
    ingress:
      - namespace: keycloak
        svc: keycloak-http
        type: public
  - name: kiali
    tags: [tracing, telemetry, observability]
    deps: [istio]
    ingress:
      - svc: kiali
        forwardPath: true
        port: 20001
        namespace: kiali
        type: public
        auth: true
  - name: knative
    tags: [serverless, functions]
    deps: [istio]
    logo: knative_logo.png
  - name: kubeapps
    tags: [dev, apps]
    deps: [operator-lifecycle-manager]
    isShared: true
    ownHost: true
    ingress:
      - svc: kubeapps
        namespace: kubeapps
        type: public
        auth: true
  - name: loki
    tags: [logging, telemetry, observability]
    deps: [grafana, prometheus]
    shortcuts:
      - title: OWASP violations
        description: ingress traffic triggering OWASP rules
        path: /explore?orgId=1&left=%5B"now-1h","now","Loki",%7B"expr":"%7Bnamespace%3D%5C"ingress%5C"%7D%20%7C%3D%5C"ModSecurity:%20%5C""%7D%5D
      - title: Gatekeeper violations
        description: Kube API violations logged by OPA gatekepeer
        path: /explore?orgId=1&left=%5B"now-1h","now","Loki",%7B"expr":"%7Bnamespace%3D%5C"gatekeeper-system%5C"%7D%20%7C%3D%5C"Policy:%20%5C""%7D%5D
    ingress:
      - host: grafana # this service is only specified to generate an icon on the dashboard that opens grafana's loki view
        path: 'explore?orgId=1&left=%5B"now-1h","now","Loki",%7B%7D,%7B"mode":"Logs"%7D,%7B"ui":%5Btrue,true,true,"none"%5D%7D%5D'
  # - name: notary
  #   isShared: true
  #   hide: true
  #   ingress:
  #     - svc: harbor-notary-server
  #       port: 4443
  #       namespace: harbor
  #       ownHost: true
  #       hide: true
  #       type: public
  #       auth: true
  - name: otomi
    hide: true
    isShared: true
    ownHost: true
    ingress:
      - svc: otomi-api
        namespace: otomi
        paths: [/api/]
        type: public
        auth: true
      - svc: otomi-console
        namespace: otomi
        type: public
        auth: true
  - name: prometheus
    tags: [metrics, observability]
    deps: [grafana]
    ingress:
      - svc: po-prometheus
        port: 9090
        namespace: monitoring
        type: public
        auth: true
  - name: vault
    tags: [secrets, security, observability]
    deps: [kubernetes-external-secrets]
    isShared: true
    ownHost: true
    ingress:
      - namespace: vault
        svc: vault-0
        port: 8200
        logo:
          name: vault
        path: ui/vault/secrets/secret/list/teams/#NS#/
        type: public
        auth: true

teamApps:
  - name: alertmanager
    ingress:
      - svc: po-alertmanager
        hasPrefix: true
        port: 9093
        logo:
          name: prometheus
        type: public
        auth: true
  - name: grafana
    ingress:
      - svc: po-grafana
        hasPrefix: true
        removeRequestHeaders:
          - authorization
        type: public
        auth: true
  - name: loki
    ingress:
      - svc: po-grafana
        host: grafana
        path: explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Loki%22,%7B%22expr%22:%22%7Bnamespace%3D%5C%22#NS#%5C%22%7D%22%7D,%7B%22mode%22:%22Logs%22%7D,%7B%22ui%22:%5Btrue,true,true,%22none%22%5D%7D%5D
        type: public
        auth: true
  - name: prometheus
    ingress:
      - svc: po-prometheus
        hasPrefix: true
        port: 9090
        type: public
        auth: true
